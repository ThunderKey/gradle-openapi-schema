plugins {
    id "com.github.muehmar.openapischema" version "2.2.0"
    id "com.diffplug.spotless"
    id 'openapischema.java'
}

dependencies {
    implementation group: 'com.fasterxml.jackson.core', name: 'jackson-core', version: '2.14.1'
    implementation group: 'com.fasterxml.jackson.core', name: 'jackson-databind', version: '2.14.1'
    implementation group: 'com.fasterxml.jackson.core', name: 'jackson-annotations', version: '2.14.1'
    implementation group: 'com.fasterxml.jackson.datatype', name: 'jackson-datatype-jsr310', version: '2.14.1'

    testImplementation group: 'org.junit.jupiter', name: 'junit-jupiter', version: '5.9.2'
    testImplementation group: 'org.junit.jupiter', name: 'junit-jupiter-params', version: '5.9.2'

    implementation group: 'javax.validation', name: 'validation-api', version: '2.0.1.Final'
    implementation group: 'org.hibernate.validator', name: 'hibernate-validator', version: '6.2.5.Final'
    implementation group: 'javax.el', name: 'javax.el-api', version: '3.0.0'
    implementation group: 'org.glassfish', name: 'javax.el', version: '3.0.0'
}

def specifications =
        [
                [name: 'v1', file: 'openapi-v1.yml'],
                [name: 'v2', file: 'openapi-v2.yml'],
                [name: 'inlineobject', file: 'openapi-inline-object.yml'],
                [name: 'nullability', file: 'openapi-nullability.yml'],
                [name: 'array', file: 'openapi-array.yml'],
                [name: 'remoteref', file: 'openapi-remote-ref-main.yml'],
                [name: 'freeform', file: 'openapi-freeform.yml'],
                [name: 'validation', file: 'openapi-validation.yml'],
                [name: 'oneof', file: 'openapi-oneof.yml'],
                [name: 'anyof', file: 'openapi-anyof.yml'],
                [name: 'allof', file: 'openapi-allof.yml'],
                [name: 'identifiers', file: 'openapi-identifiers.yml'],
                [name: 'readwriteonly', file: 'openapi-read-only-write-only.yml'],
                [name: 'specv21', file: 'openapi-spec-version-v31.yml'],
                [name: 'fullobject', file: 'openapi-full-object.yml'],
                [name: 'additionalproperties', file: 'openapi-additional-properties.yml'],
                [name: 'sasis', file: 'sasis-api.json']
        ]

openApiGenerator {
    enumDescriptionExtraction {
        enabled = true
        prefixMatcher = "`__ENUM__`:"
        failOnIncompleteDescriptions = true
    }

    formatTypeMapping {
        formatType = "username"
        classType = "com.package.UserName"
    }

    formatTypeMapping {
        formatType = "password"
        classType = "com.package.Password"
    }

    classMapping {
        fromClass = "List"
        toClass = "java.util.ArrayList"
    }

    validationMethods {
        getterSuffix = "Raw"
    }

    schemas {
        apiV1 {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-v1.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.v1"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"

            enumDescriptionExtraction {
                enabled = true
                prefixMatcher = "`__ENUM__`:"
                failOnIncompleteDescriptions = true
            }

            formatTypeMapping {
                formatType = "username"
                classType = "com.package.UserName"
            }

            formatTypeMapping {
                formatType = "MedicationKind"
                classType = "com.github.muehmar.gradle.openapi.v1.MedicationKind"
            }

            classMapping {
                fromClass = "List"
                toClass = "java.util.ArrayList"
            }
        }
        apiV2 {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-v2.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.v2"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true

            getterSuffixes {
                optionalSuffix = "Opt"
            }
        }
        inlineObject {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-inline-object.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.inlineobject"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"
        }
        nullability {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-nullability.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.nullability"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"
        }
        array {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-array.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.array"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"
        }
        remoteRef {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-remote-ref-main.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.remoteref"
            jsonSupport = "jackson"
            suffix = "Dto"
            resolveInputSpecs = false
            enableValidation = true
            builderMethodPrefix = "set"
        }
        excludeSchema {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-excluded-schema.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.excludedschema"
            jsonSupport = "jackson"
            suffix = "Dto"
            excludeSchemas = ["User"] // This schema contains an unsupported URL-reference
            enableValidation = true
            builderMethodPrefix = "set"
        }
        parameters {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-parameters.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.parameters"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"
        }
        freeForm {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-freeform.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.freeform"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"
        }
        validation {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-validation.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.validation"

            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"

            formatTypeMapping {
                formatType = "name"
                classType = "com.github.muehmar.gradle.openapi.validation.Name"
            }
        }
        oneOf {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-oneof.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.oneof"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"
        }
        anyOf {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-anyof.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.anyof"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"
        }
        allOf {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-allof.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.allof"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"
        }
        identifiers {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-identifiers.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.identifiers"
            jsonSupport = "jackson"
            suffix = ""
            enableValidation = true
            builderMethodPrefix = "set"
        }
        readOnlyWriteOnly {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-read-only-write-only.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.readwriteonly"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"
        }
        specVersionV31 {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-spec-version-v31.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.specversionv31"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"
        }
        fullObject {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-full-object.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.fullobject"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"
        }
        additionalProperties {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/openapi-additional-properties.yml"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.additionalproperties"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"
        }
        sasis {
            sourceSet = 'main'
            inputSpec = "$projectDir/src/main/resources/sasis-api.json"
            outputDir = "$buildDir/generated/openapi"
            packageName = "com.github.muehmar.gradle.openapi.sasis"
            jsonSupport = "jackson"
            suffix = "Dto"
            enableValidation = true
            builderMethodPrefix = "set"

            formatTypeMapping {
                formatType = "date-time"
                classType = "java.time.LocalDate"
            }

            constantSchemaNameMapping {
                constant = "Sasis.Register.CareProvider.Common.Models.ApiGateway.V1."
                replacement = ""
            }

            constantSchemaNameMapping {
                constant = "."
                replacement = ""
            }
        }

        specifications.forEach {spec -> {
            "noValidation${spec.name}" {
                sourceSet = 'main'
                inputSpec = "$projectDir/src/main/resources/${spec.file}"
                outputDir = "$buildDir/generated/openapi"
                packageName = "${project.group}.${project.name}.api.novalidation.${spec.name}.model"
                jsonSupport = "jackson"
                suffix = "Dto"
                enableValidation = false
                builderMethodPrefix = "set"
            }
        }}

        specifications.forEach {spec -> {
            "noJsonSupport${spec.name}" {
                sourceSet = 'main'
                inputSpec = "$projectDir/src/main/resources/${spec.file}"
                outputDir = "$buildDir/generated/openapi"
                packageName = "${project.group}.${project.name}.api.nojsonsupport.${spec.name}.model"
                jsonSupport = "none"
                suffix = "Dto"
                enableValidation = true
                builderMethodPrefix = "set"
            }
        }}

        specifications.forEach {spec -> {
            "noJsonSupportAndValidation${spec.name}" {
                sourceSet = 'main'
                inputSpec = "$projectDir/src/main/resources/${spec.file}"
                outputDir = "$buildDir/generated/openapi"
                packageName = "${project.group}.${project.name}.api.nojsonsupportandvalidation.${spec.name}.model"
                jsonSupport = "none"
                suffix = "Dto"
                enableValidation = false
                builderMethodPrefix = "set"
            }
        }}
    }
}

afterEvaluate {
    tasks.named("generateRemoteRefModel") {
        inputs.file("$projectDir/src/main/resources/openapi-remote-ref-sub.yml")
    }
}

